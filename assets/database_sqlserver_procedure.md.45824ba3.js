import{_ as s,o as a,c as n,O as l}from"./chunks/framework.08728be1.js";const D=JSON.parse('{"title":"存储过程","description":"","frontmatter":{},"headers":[],"relativePath":"database/sqlserver/procedure.md","filePath":"database/sqlserver/procedure.md","lastUpdated":1690342715000}'),p={name:"database/sqlserver/procedure.md"},o=l(`<h1 id="存储过程" tabindex="-1">存储过程 <a class="header-anchor" href="#存储过程" aria-label="Permalink to &quot;存储过程&quot;">​</a></h1><h2 id="游标" tabindex="-1">游标 <a class="header-anchor" href="#游标" aria-label="Permalink to &quot;游标&quot;">​</a></h2><h3 id="游标语法" tabindex="-1">游标语法 <a class="header-anchor" href="#游标语法" aria-label="Permalink to &quot;游标语法&quot;">​</a></h3><p>游标的使用过程：声明游标、打开游标、遍历游标、关闭游标</p><ul><li><p>声明游标：DECLARE 游标名称 CURSOR FOR 查询语句;</p></li><li><p>打开游标：open 游标名称;</p></li><li><p>遍历游标：fetch 游标名称 into 变量列表;</p><p>取出当前行的结果，将结果放在对应的变量中，并将游标指针指向下一行的数据。</p><p>当调用 fetch 的时候，会获取当前行的数据，如果当前行无数据，会引发 mysql 内部的 NOT FOUND 错误。</p></li><li><p>关闭游标：close 游标名称; 游标使用完毕之后一定要关闭。</p></li></ul><p>例子：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">DECLARE</span><span style="color:#A6ACCD;"> @name </span><span style="color:#F78C6C;">nvarchar</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">255</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--声明游标</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--select中的参数，必须要和游标取出来的变量名相同</span></span>
<span class="line"><span style="color:#F78C6C;">DECLARE</span><span style="color:#A6ACCD;"> mycursor </span><span style="color:#F78C6C;">CURSOR</span></span>
<span class="line"><span style="color:#A6ACCD;">FOR </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> user_name </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--打开游标</span></span>
<span class="line"><span style="color:#F78C6C;">OPEN</span><span style="color:#A6ACCD;"> mycursor ;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--从游标中取出数据，赋值到刚才定义的变量中</span></span>
<span class="line"><span style="color:#F78C6C;">FETCH</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NEXT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> mycursor </span><span style="color:#F78C6C;">INTO</span><span style="color:#A6ACCD;"> @name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--事务--当 xact_abort 选项为 on 时，sql server 在遇到错误时会终止执行并 rollback 整个事务。</span></span>
<span class="line"><span style="color:#F78C6C;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">xact_abort</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">on</span></span>
<span class="line"><span style="color:#F78C6C;">begin</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">transaction</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--判断游标的状态</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--0 fetch语句成功</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--1 fetch语句失败或者此行不在结果集中</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--2 提取的行不存在</span></span>
<span class="line"><span style="color:#F78C6C;">WHILE</span><span style="color:#A6ACCD;"> (@@fetch_status </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> &amp;&amp; @@error </span><span style="color:#89DDFF;">&lt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#F78C6C;">BEGIN</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">print</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">姓名：</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> @name);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">if</span><span style="color:#A6ACCD;"> @@error </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">begin</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FETCH</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NEXT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> mycursor </span><span style="color:#F78C6C;">INTO</span><span style="color:#A6ACCD;"> @name ;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">end</span></span>
<span class="line"><span style="color:#F78C6C;">END</span><span style="color:#A6ACCD;"> ;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">if</span><span style="color:#A6ACCD;">(@@error </span><span style="color:#89DDFF;">&lt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#F78C6C;">begin</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">rollback</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">tran</span></span>
<span class="line"><span style="color:#F78C6C;">end</span></span>
<span class="line"><span style="color:#F78C6C;">else</span></span>
<span class="line"><span style="color:#F78C6C;">begin</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">commit</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">transaction</span></span>
<span class="line"><span style="color:#F78C6C;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--关闭游标</span></span>
<span class="line"><span style="color:#F78C6C;">CLOSE</span><span style="color:#A6ACCD;"> mycursor ;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">--释放游标</span></span>
<span class="line"><span style="color:#F78C6C;">DEALLOCATE</span><span style="color:#A6ACCD;"> mycursor ;</span></span></code></pre></div><h3 id="标题2-1-3-1" tabindex="-1">标题2.1.3.1 <a class="header-anchor" href="#标题2-1-3-1" aria-label="Permalink to &quot;标题2.1.3.1&quot;">​</a></h3><h3 id="标题2-1-3-2" tabindex="-1">标题2.1.3.2 <a class="header-anchor" href="#标题2-1-3-2" aria-label="Permalink to &quot;标题2.1.3.2&quot;">​</a></h3><h2 id="标题2-2" tabindex="-1">标题2.2 <a class="header-anchor" href="#标题2-2" aria-label="Permalink to &quot;标题2.2&quot;">​</a></h2><h3 id="标题2-2-3-1" tabindex="-1">标题2.2.3.1 <a class="header-anchor" href="#标题2-2-3-1" aria-label="Permalink to &quot;标题2.2.3.1&quot;">​</a></h3><h3 id="标题2-2-3-2" tabindex="-1">标题2.2.3.2 <a class="header-anchor" href="#标题2-2-3-2" aria-label="Permalink to &quot;标题2.2.3.2&quot;">​</a></h3><h3 id="标题2-2-3-3" tabindex="-1">标题2.2.3.3 <a class="header-anchor" href="#标题2-2-3-3" aria-label="Permalink to &quot;标题2.2.3.3&quot;">​</a></h3><h2 id="标题2-3" tabindex="-1">标题2.3 <a class="header-anchor" href="#标题2-3" aria-label="Permalink to &quot;标题2.3&quot;">​</a></h2><h3 id="标题2-3-3-1" tabindex="-1">标题2.3.3.1 <a class="header-anchor" href="#标题2-3-3-1" aria-label="Permalink to &quot;标题2.3.3.1&quot;">​</a></h3><h3 id="标题2-3-3-2" tabindex="-1">标题2.3.3.2 <a class="header-anchor" href="#标题2-3-3-2" aria-label="Permalink to &quot;标题2.3.3.2&quot;">​</a></h3>`,16),e=[o];function t(r,c,C,i,y,A){return a(),n("div",null,e)}const d=s(p,[["render",t]]);export{D as __pageData,d as default};
